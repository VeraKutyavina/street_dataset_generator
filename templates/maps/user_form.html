{% extends 'maps/user_template.html' %}

{% block body %}
    <div id="buttons" class="buttons-wrapper">
        <form class="addressForm" action="/maps/create_video" method="POST">
            {% csrf_token %}
            <label>
                Street Name
                <input class="form-control" id="address-input" style="width: 100%" name="address">
            </label>
            <div class="my-2">
                ИЛИ
            </div>
             <div class="mb-1">
                <label>
                North
                <input class="form-control" type="number" id="north-input" style="width: 100%" name="north">
                </label>
                <label>
                    South
                    <input class="form-control" type="number" id="south-input" style="width: 100%" name="south">
                </label>
                <label>
                    East
                    <input class="form-control" type="number" id="east-input" style="width: 100%" name="east">
                </label>
                <label>
                    West
                    <input class="form-control" type="number" id="west-input" style="width: 100%" name="west">
                </label>
            </div>
            <label>
                Объект
                <select id="item-select" class="form-select mt-2" aria-label="Default select example">
                    <option value="cafe=amenity">Кафе</option>
                    <option value="restaurant=amenity">Ресторан</option>
                    <option value="college=amenity">Колледж</option>
                    <option value="traffic_park=amenity">Парковка</option>
                    <option value="university=amenity">Университет</option>
                    <option value="bus_station=amenity">Автобусная остановка</option>
                    <option value="cinema=amenity">Кинотеатр</option>
                    <option value="house=building">Дом</option>
                    <option value="apartments=building">Квартира</option>
                    <option value="hotel=building">Отель</option>
                </select>
            </label>
            <br />
{#            <button type="submit" class="btn btn-primary pink-button">Record Video</button>#}
            <button type="button" id="record-video" class="btn btn-primary pink-button">Record Video</button>
        </form>
        <div id="data-loader" class="lds-ring"><div></div><div></div><div></div><div></div></div>
         <form action="">
            {% csrf_token %}
            <button type="button" id="get-result" class="btn btn-primary pink-button">Get cars count</button>
        </form>
        <div id="counting-loader" class="lds-ring"><div></div><div></div><div></div><div></div></div>
        <form action="">
            {% csrf_token %}
            <button type="button" id="get_osm_data" class="btn btn-primary pink-button">Get data</button>
        </form>
        <div id="osm-loader" class="lds-ring"><div></div><div></div><div></div><div></div></div>
    </div>
    <div id="success-upload" class="result">Video uploaded successfully!</div>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.1.js" integrity="sha256-3zlB5s2uwoUzrXK3BT7AX3FyvojsraNFxCc2vC/7pNI=" crossorigin="anonymous"></script>
	<script src="https://api-maps.yandex.ru/2.1/?apikey=fe94c607-ccc3-4d84-a017-3082f44c2512&lang=ru_RU">
	</script>
        {% load static %}
    <script>

        const $crf_token = $('[name="csrfmiddlewaretoken"]').attr('value');
        const sendAjaxQuery = (url, loader, button, text, hide) => {
            $(loader).show();
            $(button).hide();
            $.ajax({
                url: url,
                type: "POST",
                data : {
                    north: $("#north-input").val(),
                    south: $("#south-input").val(),
                    east: $("#east-input").val(),
                    west: $("#west-input").val(),
                    address: $("#address-input").val(),
                    osm_item: $("#item-select").val(),
                    csrfmiddlewaretoken: $crf_token,
                },
                headers:{"X-CSRFToken": $crf_token},
                error: (e) => console.log(e),
                complete: () => {
                    $(loader).hide();
                    $(button).show();
                    $(text).show();
                    $(hide).hide();
                },
                success: (resp) => {
                    console.log(resp.count)
                    if (!text) $('#buttons').after("<div class=\"result-success\"> Result: " + resp.count + "</div>")
                }
            })
        }

        $("#record-video").click(() => {
            sendAjaxQuery("create_video", '#data-loader', "#record-video", "#success-upload")
        });

        $("#get-result").click(() => {
            sendAjaxQuery("counting", "#counting-loader", "#get-result", undefined, "#success-upload")
        });

        $("#get_osm_data").click(() => {
            sendAjaxQuery("get_osm_data", "#osm-loader", "#get_osm_data", undefined, "#success-upload")
        });
    </script>

{% endblock body %}